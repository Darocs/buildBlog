<div class="calendar">
  <div class="calendar-header">
    <button id="prevMonth">&lt;</button>
    <h2 id="calendarTitle"></h2>
    <button id="nextMonth">&gt;</button>
  </div>
  <div class="calendar-weekdays">
    <div>ПН</div><div>ВТ</div><div>СР</div><div>ЧТ</div><div>ПТ</div><div>СБ</div><div>ВС</div>
  </div>
  <div id="calendarDays" class="calendar-days"></div>
</div>

<script>
  const posts = JSON.parse(`[ 
    {{- $pages := where .Site.RegularPages "Type" "news" -}}
    {{- range $index, $el := $pages -}}
      {{- if $index }},{{ end -}}
      {
        "date": "{{ .Date.Format "2006-01-02" }}",
        "title": {{ .Title | jsonify }},
        
        "image": {{- $imagePaths := slice -}}
          {{- $folder := .Params.media_folder -}}
          {{- $fullPath := path.Join "assets" $folder -}}
          {{- $files := readDir $fullPath -}}
          {{- range $files }}
            {{- if (findRE "\\.(jpg|jpeg|png|webp)$" .Name) }}
              {{- $webPath := printf "/%s/%s" $folder .Name }}
              {{- $tmp := slice $webPath }}
              {{- $imagePaths = union $imagePaths $tmp }}
            {{- end -}}
          {{- end -}}
          {{- if gt (len $imagePaths) 0 }}{{ index $imagePaths 0 | jsonify }}{{ else }}""{{ end }},
        
        "url": "{{ .RelPermalink }}"
      }
    {{- end -}}
  ]`);

  posts.forEach(post => {
    post.date = new Date(post.date);
  });

  console.log("Посты для календаря:");
  posts.forEach(p => console.log(p.title, p.image));

  let currentDate = new Date();

  function renderCalendar() {
    const title = document.getElementById("calendarTitle");
    const daysContainer = document.getElementById("calendarDays");
    const month = currentDate.getMonth();
    const year = currentDate.getFullYear();

    title.textContent = currentDate.toLocaleDateString("ru-RU", {
      month: "long",
      year: "numeric"
    });

    const firstDay = new Date(year, month, 1);
    const startDay = (firstDay.getDay() + 6) % 7;
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    daysContainer.innerHTML = "";

    for (let i = 0; i < startDay; i++) {
      const empty = document.createElement("div");
      empty.classList.add("calendar-day", "empty");
      daysContainer.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const dayDate = new Date(year, month, day);
      const post = posts.find(p =>
        p.date.getDate() === dayDate.getDate() &&
        p.date.getMonth() === dayDate.getMonth() &&
        p.date.getFullYear() === dayDate.getFullYear()
      );

      const dayElem = document.createElement("div");
      dayElem.classList.add("calendar-day");

      if (post) {
        dayElem.innerHTML = `
          <a href="${post.url}" title="${post.title}" class="calendar-post-link">
            <div class="calendar-post-image" style="background-image: url('${post.image}')">
              <span class="calendar-post-day">${String(day).padStart(2, '0')}</span>
            </div>
          </a>
        `;
      } else {
        dayElem.innerHTML = `<div class="day-number">${day}</div>`;
      }

      daysContainer.appendChild(dayElem);
    }
  }

  document.getElementById("prevMonth").addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  });

  document.getElementById("nextMonth").addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  });

  renderCalendar();
</script>
